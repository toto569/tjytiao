<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3x3 拼图游戏</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: #f0f2f5;
    margin: 0;
  }

  h1 {
    color: #333;
    margin-bottom: 20px;
  }

  #image-selection, #game-controls {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  #image-selection img {
    width: 80px;
    height: 80px;
    cursor: pointer;
    border: 3px solid #ccc;
    border-radius: 8px;
    transition: transform 0.2s, border-color 0.2s;
  }

  #image-selection img:hover, #image-selection img.selected {
    border-color: #007bff;
    transform: scale(1.1);
  }

  #puzzle-container {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    grid-template-rows: repeat(3, 100px);
    border: 2px solid #333;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none; /* 初始隐藏 */
  }

  .puzzle-piece {
    width: 100px;
    height: 100px;
    background-size: 300px 300px;
    border: 1px solid #fff;
    cursor: pointer;
    transition: transform 0.2s;
  }
  
  .puzzle-piece:hover {
      transform: scale(1.05);
  }

  .control-button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      transition: background-color 0.3s;
  }

  .control-button:hover {
      background-color: #0056b3;
  }

  #message {
      margin-top: 15px;
      font-size: 1.2em;
      color: #28a745;
      font-weight: bold;
      height: 25px;
  }

</style>
</head>
<body>

<h1>选择一张图片开始游戏</h1>

<div id="image-selection">
  <img src="pt/pt1.png" alt="拼图1" data-src="pt/pt1.png">
  <img src="pt/pt2.png" alt="拼图2" data-src="pt/pt2.png">
  <img src="pt/pt3.png" alt="拼图3" data-src="pt/pt3.png">
</div>

<div id="puzzle-container"></div>
<div id="message"></div>

<div id="game-controls">
    <button class="control-button" id="reset-button" style="display: none;">重置游戏</button>
    <a href="index.html" class="control-button" style="text-decoration: none;">返回主页</a>
</div>


<script>
  const puzzleContainer = document.getElementById('puzzle-container');
  const imageSelectionContainer = document.getElementById('image-selection');
  const selectionImages = imageSelectionContainer.querySelectorAll('img');
  const resetButton = document.getElementById('reset-button');
  const messageEl = document.getElementById('message');
  
  let pieces = [];
  let draggedPiece = null;
  let selectedImageSrc = '';

  // 1. 图片选择逻辑
  selectionImages.forEach(img => {
    img.addEventListener('click', (e) => {
        // 移除其他图片的选中状态
        selectionImages.forEach(i => i.classList.remove('selected'));
        // 添加选中状态
        e.target.classList.add('selected');
        
        selectedImageSrc = e.target.dataset.src;
        startGame(selectedImageSrc);
    });
  });

  // 2. 开始游戏函数
  function startGame(imageSrc) {
    // 清空并准备游戏区域
    puzzleContainer.innerHTML = '';
    messageEl.textContent = '';
    pieces = [];
    puzzleContainer.style.display = 'grid';
    resetButton.style.display = 'inline-block';
    imageSelectionContainer.style.display = 'none'; // 隐藏图片选择
    document.querySelector('h1').textContent = '拖拽碎片完成拼图';

    // 创建并打乱拼图碎片
    for (let i = 0; i < 9; i++) {
      const piece = document.createElement('div');
      piece.classList.add('puzzle-piece');
      piece.style.backgroundImage = `url('${imageSrc}')`; // [1, 2]
      piece.style.backgroundPosition = `-${(i % 3) * 100}px -${Math.floor(i / 3) * 100}px`;
      piece.dataset.originalIndex = i; // 存储原始索引
      
      pieces.push({ element: piece, originalIndex: i });
    }

    // 打乱顺序
    shuffle(pieces);

    // 添加到容器并设置拖拽事件
    pieces.forEach((p, currentIndex) => {
        p.element.dataset.currentIndex = currentIndex; // 存储当前索引
        puzzleContainer.appendChild(p.element);
        addDragAndDropHandlers(p.element);
    });
  }

  // 3. 为碎片添加拖拽事件
  function addDragAndDropHandlers(piece) {
    piece.draggable = true;

    piece.addEventListener('dragstart', (e) => {
      draggedPiece = e.target;
      setTimeout(() => e.target.style.opacity = '0.5', 0);
    });
    
    piece.addEventListener('dragend', (e) => {
        e.target.style.opacity = '1';
    });

    piece.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    piece.addEventListener('drop', (e) => {
      e.preventDefault();
      if (e.target.classList.contains('puzzle-piece') && e.target !== draggedPiece) {
        // 获取拖拽和放置元素的当前位置
        const fromIndex = parseInt(draggedPiece.dataset.currentIndex);
        const toIndex = parseInt(e.target.dataset.currentIndex);
        
        // 交换数组中的元素
        [pieces[fromIndex], pieces[toIndex]] = [pieces[toIndex], pieces[fromIndex]];
        
        // 更新DOM
        updatePuzzleDOM();
        checkWin();
      }
    });
  }

  // 4. 更新拼图的DOM结构
  function updatePuzzleDOM() {
      puzzleContainer.innerHTML = ''; // 清空容器
      pieces.forEach((p, index) => {
          p.element.dataset.currentIndex = index; // 更新当前索引
          puzzleContainer.appendChild(p.element);
      });
  }

  // 5. 打乱数组的函数
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
  }

  // 6. 检查是否胜利
  function checkWin() {
    const isWin = pieces.every((p, index) => p.originalIndex === parseInt(p.element.dataset.originalIndex));

    if (isWin) {
      messageEl.textContent = '恭喜你，拼图完成！';
      // 移除拖拽功能
      puzzleContainer.querySelectorAll('.puzzle-piece').forEach(p => p.draggable = false);
    }
  }
  
  // 7. 重置按钮功能
  resetButton.addEventListener('click', () => {
      if (selectedImageSrc) {
          startGame(selectedImageSrc);
      }
  });

</script>

</body>
</html>
